<!DOCTYPE html>
<html>

<head>
  <title>{{ user.username }}</title>
</head>

<body>
  <h1><a href="/">RENTER</a></h1>

  {% for message in get_flashed_messages() %}
    <p style="color:green">{{ message }}</p>
  {% endfor %}

  <p>
    Olet kirjautunut nimellä: <a href="/user/{{ session.user_id }}">{{ session.username }}</a> (id: {{ session.user_id }})
  </p>

  <h1>Käyttäjä {{ user.username }} (id:{{ user.id }})</h1>
  <h2>Luokitus: {{ user.rating }}</h2>
  {% if rating_permission %}
    <h3>Anna luokitus</h3>

    <form action="/rate_user/{{ user.id }}" method="post">
      <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
      <select name="rating">
        {% for i in range(0, 6) %}
          <option value="{{ i }}" {% if user_rating == i %}selected{% endif %}>
            {{ i }}
          </option>
        {% endfor %}
      </select>
      <button type="submit">Tallenna luokitus</button>
    </form>
  {% endif %}

  {% if session.user_id == user.id %}
    <h3>Yhteystiedot</h3>

    {% if edit_contact %}
      <form action="/user/{{ user.id }}" method="post">
        <p>
          Puhelin:<br>
          <input type="text" name="phone" value="{{ user.phone or '' }}" maxlength="30">
        </p>

        <p>
          Sähköposti:<br>
          <input type="text" name="email" value="{{ user.email or '' }}" maxlength="50">
        </p>

        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
        <input type="submit" value="Päivitä yhteystiedot">
      </form>
    {% else %}
      <p>
        Puhelin: {{ user.phone or "-" }}<br>
        Sähköposti: {{ user.email or "-" }}
      </p>

      <form action="/user/{{ user.id }}" method="get">
        <input type="hidden" name="edit_contact" value="1">
        <button type="submit">Muokkaa yhteystietoja</button>
      </form>
    {% endif %}

    <p>
      <a href="/new_listing">Uusi ilmoitus</a>
    </p>
  {% endif %}

  <h2>
    Käyttäjällä {{ user.username }} on {{ listings|length }}
    {% if listings|length == 1 %}
      ilmoitus:
    {% else %}
      ilmoitusta:
    {% endif %}
  </h2>

  <ul>
    {% for listing in listings %}
      <li>
        <a href="/listing/{{ listing.id }}">
          {{ listing.municipality }} {{ listing.rooms }} h
          {{ listing.size|float|int if listing.size|float == listing.size|float|int else listing.size|string|replace(".", ",") }} m²
          {{ listing.rent }} €
        </a>
      </li>
    {% endfor %}
  </ul>

  {% if session.user_id == user.id %}
    <h2>Omat hakemukset</h2>

    {% if deals %}
      <ul>
        {% for deal in deals %}
          <li>
            <a href="/listing/{{ deal.listing_id }}">
              {{ deal.size }} m², {{ deal.rent }} €</a><br>
            {% if user.id == deal.owner_id %}
              Hakija: <a href="/user/{{ deal.tenant_id }}">{{ deal.tenant_username }}</a><br>
              Puhelin: {{ deal.tenant_phone }}<br>
              Sähköposti: {{ deal.tenant_email }}
            {% else %}
              Ilmoittaja: <a href="/user/{{ deal.owner_id }}">{{ deal.owner_username }}</a><br>
              Puhelin: {{ deal.owner_phone }}<br>
              Sähköposti: {{ deal.owner_email }}
            {% endif %}
          </li>
          <br>
        {% endfor %}
      </ul>
    {% elif user_offers %}
      <ul>
        {% for offer in user_offers %}
          <li>
            <a href="/listing/{{ offer.listing_id }}">
              {{ offer.municipality }} {{ offer.rooms }} h
              {{ offer.size|float|int if offer.size|float == offer.size|float|int else offer.size|string|replace(".", ",") }} m²
              {{ offer.rent }} €</a>
            {% if offer.owner_accepted %}
              <b>Hyväksytty</b>
            {% else %}
              <b>Odottaa</b>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>Et ole lähettänyt vielä yhtään hakemusta.</p>
    {% endif %}
  {% endif %}

  {% if session.user_id == user.id %}
  <h2>Tykkäämäsi ilmoitukset</h2>
    {% if liked %}
      <ul>
        {% for listing in liked %}
          <li>
            <a href="/listing/{{ listing.id }}">
              {{ listing.municipality }} {{ listing.rooms }} h
              {{ listing.size|float|int if listing.size|float == listing.size|float|int else listing.size|string|replace(".", ",") }} m²
              {{ listing.rent }} €</a>
            <form action="/toggle_like/{{ listing.id }}" method="post" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
              <button type="submit">Poista tykkäys</button>
            </form>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>Et ole tykännyt vielä yhdestäkään ilmoituksesta.</p>
    {% endif %}
  {% endif %}

  <p>
    <a href="javascript:history.back()">Takaisin</a>
  </p>

  {% if session.username %}
    <form action="/logout" method="post">
      <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
      <button type="submit">Kirjaudu ulos</button>
    </form>
  {% endif %}

</body>

</html>
