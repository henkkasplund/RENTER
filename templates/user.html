{% extends "layout.html" %}

{% block title %}{{ user.username }}{% endblock %}

{% block content %}
<section class="medium">

  <h1>Käyttäjä {{ user.username }} (ID: {{ user.id }})</h1>

  <h2>Luokitus: {{ user.rating }}</h2>

  {% if rating_permission %}
    <h3>Anna luokitus</h3>

    <form class="form-stack" action="/rate_user/{{ user.id }}" method="post">
      <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">

      <div>
        <select name="rating">
          {% for i in range(0, 6) %}
            <option value="{{ i }}" {% if user_rating == i %}selected{% endif %}>
              {{ i }}
            </option>
          {% endfor %}
        </select>
      </div>

      <button type="submit">Tallenna luokitus</button>
    </form>
  {% endif %}


  {% if session.user_id == user.id %}
    <h3>Yhteystiedot</h3>

    {% if edit_contact %}
      <form class="form-stack" action="/user/{{ user.id }}" method="post">

        <div>
          Puhelin
          <input type="text" name="phone" value="{{ user.phone or '' }}" maxlength="30">
        </div>

        <div>
          Sähköposti
          <input type="text" name="email" value="{{ user.email or '' }}" maxlength="50">
        </div>

        <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
        <input type="submit" value="Päivitä yhteystiedot">
      </form>

    {% else %}
      <p>Puhelin: {{ user.phone or "-" }}</p>
      <p>Sähköposti: {{ user.email or "-" }}</p>

      <form action="/user/{{ user.id }}" method="get">
        <input type="hidden" name="edit_contact" value="1">
        <button type="submit">Muokkaa yhteystietoja</button>
      </form>
    {% endif %}
  {% endif %}


  <h2>
    Käyttäjällä {{ user.username }} on {{ listings|length }}
    {% if listings|length == 1 %} ilmoitus:
    {% else %} ilmoitusta:
    {% endif %}
  </h2>

  <ul>
    {% for listing in listings %}
      <li>
        <a href="/listing/{{ listing.id }}">
          {{ listing.municipality }} {{ listing.rooms }} h
          {{ listing.size | format_size }} m²
          {{ listing.rent }} €
        </a>
      </li>
    {% endfor %}
  </ul>


  {% if session.user_id == user.id %}

    <h2>Omat hakemukset</h2>

    {% if sent_offers %}
      <ul>
        {% for offer in sent_offers %}
          <li>
            <a href="/listing/{{ offer.listing_id }}">
              {{ offer.municipality }} {{ offer.rooms }} h
              {{ offer.size | format_size }} m²
              {{ offer.rent }} €
            </a>

            {% if offer.owner_accepted %}
              <strong>Hyväksytty</strong>
            {% else %}
              <strong>Odottaa</strong>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p>Et ole lähettänyt vielä yhtään hakemusta.</p>
    {% endif %}


    <h2>Saapuneet hakemukset</h2>

    {% if received_offers %}
      <ul>
        {% for offer in received_offers %}
          <li>
            <p>
              <a href="/listing/{{ offer.listing_id }}">
                {{ offer.municipality }} {{ offer.rooms }} h
                {{ offer.size | format_size }} m²
                {{ offer.rent }} €
              </a>
            </p>

            <p>
              Hakija:
              <a href="/user/{{ offer.tenant_id }}">
                {{ offer.tenant_username }}
              </a>
            </p>

            <p>Tarjous: {{ offer.price }} €</p>

            {% if offer.owner_accepted %}
              <strong>Hyväksytty</strong>
            {% else %}
              <strong>Odottaa</strong>

              <form class="form-stack" action="/handle_offer/{{ offer.id }}" method="post">
                <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">

                <div class="grid grid-small">
                  <button type="submit" name="decision" value="accept">Hyväksy</button>
                  <button type="submit" name="decision" value="reject">Hylkää</button>
                </div>
              </form>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

    {% else %}
      <p>Ei saapuneita hakemuksia.</p>
    {% endif %}


    <h2>Poista käyttäjä</h2>
    <p>
      <a class="button-link" href="/delete_account">Poista käyttäjätili</a>
    </p>

  {% endif %}

</section>

{% endblock %}