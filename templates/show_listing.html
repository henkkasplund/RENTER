<!DOCTYPE html>
<html>

<head>
  <title>
    {{ listing.municipality }} {{ listing.rooms }} h
    {{ listing.size|float|int if listing.size|float == listing.size|float|int else listing.size|string|replace(".", ",") }} m²
    {{ listing.rent }} €
  </title>
</head>

<body>
  <h1><a href="/">RENTER</a></h1>

  {% for message in get_flashed_messages() %}
    <p style="color:green">{{ message }}</p>
  {% endfor %}

  {% if session.username %}
    <p>
      Olet kirjautunut nimellä: <a href="/user/{{ session.user_id }}">{{ session.username }}</a> (id: {{ session.user_id }})
    </p>
  {% endif %}
  <h2>
    {{ listing.municipality }} {{ listing.rooms }} h
    {{ listing.size|float|int if listing.size|float == listing.size|float|int else listing.size|string|replace(".", ",") }} m²
    {{ listing.rent }} €
  </h2>

  {% if session.user_id == listing.user_id %}
    <p>
      <a href="/edit_listing/{{ listing.id }}">Muokkaa</a>
      <a href="/remove_listing/{{ listing.id }}">Poista</a>
      <a href="/images/{{ listing.id }}">Kuvat</a>
    </p>
    <h2>Hakijat:</h2>
    <ul>
      {% for offer in offers %}
        <li>
          {{ offer.price }} €
          <a href="/user/{{ offer.user_id }}">{{ offer.username }}</a>
          {% if offer.owner_accepted %}
            (Hyväksytty)
            <p><b>Hakijan yhteystiedot:</b></p>
            <p>
              Puhelin: {{ offer.phone }} <br>
              Sähköposti: {{ offer.email }}
            </p>
          {% else %}
            (Odottaa vastausta)
          {% endif %}

          {% if not offer.owner_accepted %}
             <form action="/handle_offer/{{ offer.id }}" method="post" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
              <button type="submit" name="decision" value="accept">Hyväksy</button>
            </form>
            <form action="/handle_offer/{{ offer.id }}" method="post" style="display:inline;">
              <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
              <button type="submit" name="decision" value="reject">Hylkää</button>
            </form>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if session.username and session.user_id != listing.user_id %}

    {% if rented %}
      <p><b>Kohde on jo vuokrattu.</b></p>

    {% elif user_offer %}
      {% if user_offer.owner_accepted %}
        <h2>Hakemuksesi on hyväksytty!</h2><br>
        <h3>Ilmoittajan yhteystiedot:</h3>
        <p>
          Puhelin: {{ listing.phone }} <br>
          Sähköposti: {{ listing.email }}
        </p>
      {% else %}
        <p>Hakemus lähetetty! Odotetaan ilmoittajan vastausta.</p>
      {% endif %}

    {% else %}
      <h2>Vuokraa kohde:</h2>

        {% if edit_offer %}
        <form action="/create_offer" method="post">
          Tarjous:<br>
          <input type="text" name="price" size="8" pattern="^[1-9][0-9]{0,4}$" required> €
          <input type="hidden" name="listing_id" value="{{ listing.id }}">
          <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
          <input type="submit" value="Lähetä hakemus">
        </form>
      {% else %}
        <form action="/listing/{{ listing.id }}" method="get">
          <input type="hidden" name="edit_offer" value="1">
          <button type="submit">Lähetä hakemus</button>
        </form>
      {% endif %}
    {% endif %}
  {% endif %}

  {% if session.user_id and session.user_id != listing.user_id %}
    {% if offers %}
      <h3>Oma hakemus:</h3>
      <ul>
        {% for offer in offers %}
          <li>
            {{ offer.price }} €
            {% if offer.owner_accepted %}
              (Hyväksytty)
            {% else %}
              (Odottaa)
              <form action="/edit_offer/{{ offer.id }}" method="post" style="display:inline;">
                <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                <input type="text" name="price" value="{{ offer.price }}" size="6" pattern="^[1-9][0-9]{0,4}$" required>
                <button type="submit" name="action" value="update">Päivitä</button>
                <button type="submit" name="action" value="delete">Poista</button>
              </form>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endif %}

  {% if session.username %}
    <p>
      Ilmoittaja: <a href="/user/{{listing.user_id}}">{{ listing.username }}</a>
    </p>
    <form action="/toggle_like/{{ listing.id }}" method="post">
      <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
      {% if likes.liked %}
        <button type="submit">Poista tykkäys</button>
      {% else %}
        <button type="submit">Tykkää</button>
      {% endif %}
    </form>
    <p>Tykkäyksiä: {{ likes.likes }}</p>
  {% endif %}

  {% for image in images %}
    <img src="/image/{{ image.id }}"/>
  {% endfor %}

  <h3>Asunnon tiedot</h3>

  <p>
    Asuntotyyppi: {{ listing.property_type }}
  </p>
  <p>
    Huonemäärä: {{ listing.rooms }} h
  </p>
  <p>
    Neliömäärä: {{ listing.size|float|int if listing.size|float == listing.size|float|int else listing.size|string|replace(".", ",") }} m²
  </p>
  <p>
    Vuokrahinta: {{ listing.rent }} €
  </p>
  <p>
    Osoite: {{ listing.address }}, {{ listing.postcode }} {{ listing.municipality }}
  </p>
  <p>
    {% if listing.floor %}
      Kerros: {{ listing.floor }} / {{ listing.floors }}
    {% else %}
      Kerroksia: {{ listing.floors }}
    {% endif %}
  </p>
  <p>
    Kunto: {{ listing.condition }}
  </p>
  <p>
    Sauna: {{ "Kyllä" if listing.sauna else "Ei" }}
  </p>
  <p>
    Parveke: {{ "Kyllä" if listing.balcony else "Ei" }}
  </p>
  <p>
    Kuvaus:<br>
    {{ listing.description | show_lines }}
  </p>

   {% if listing.floor %}
  <h3>Taloyhtiön tiedot</h3>

  <p>
    Sauna: {{ "Kyllä" if listing.bath else "Ei" }}
  </p>
  <p>
    Hissi: {{ "Kyllä" if listing.elevator else "Ei" }}
  </p>
  <p>
    Pyykkitupa: {{ "Kyllä" if listing.laundry else "Ei" }}
  </p>
  <p>
    Häkkikellari: {{ "Kyllä" if listing.cellar else "Ei" }}
  </p>
  <p>
    Uima-allas: {{ "Kyllä" if listing.pool else "Ei" }}
  </p>
  {% endif %}

  <p>
    <a href="javascript:history.back()">Takaisin</a>
  </p>

</body>

</html>