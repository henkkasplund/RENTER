{% extends "layout.html" %}

{% block title %}
  {{ listing.municipality }} {{ listing.rooms }} h
  {{ listing.size | format_size }} m²
  {{ listing.rent }} €
{% endblock %}

{% block content %}
<section class="medium">

  <h2>
    {{ listing.municipality }} {{ listing.rooms }} h
    {{ listing.size | format_size }} m²
    {{ listing.rent }} €
  </h2>

  <h3>Tykkäyksiä: {{ likes.likes }}</h3>

  {% if session.user_id != listing.user_id %}
    <form action="/toggle_like/{{ listing.id }}" method="post">
      <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
      {% if likes.liked %}
        <button type="submit">Poista tykkäys</button>
      {% else %}
        <button type="submit">Tykkää</button>
      {% endif %}
    </form>
  {% endif %}

  {% if images %}
    <div class="grid grid-large">
      {% for image in images %}
        <div class="listing-card">
          <img src="/image/{{ image.id }}" alt="Listing image">
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% if session.user_id == listing.user_id %}
    <div class="grid grid-small">
      <a class="button-link" href="/edit_listing/{{ listing.id }}">Muokkaa</a>
      <a class="button-link" href="/remove_listing/{{ listing.id }}">Poista</a>
      <a class="button-link" href="/images/{{ listing.id }}">Kuvat</a>
    </div>

    <h3>Hakijat</h3>
    <ul>
      {% for offer in offers %}
        <li>
          {{ offer.price }} €
          <a href="/user/{{ offer.user_id }}">{{ offer.username }}</a>

          {% if offer.owner_accepted %}
            (Hyväksytty)

            <p><strong>Hakijan yhteystiedot:</strong></p>
            <p>Puhelin: {{ offer.phone }}</p>
            <p>Sähköposti: {{ offer.email }}</p>

          {% else %}
            (Odottaa vastausta)

            <form class="form-stack" action="/handle_offer/{{ offer.id }}" method="post">
              <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
              <div class="grid grid-small">
                <button type="submit" name="decision" value="accept">Hyväksy</button>
                <button type="submit" name="decision" value="reject">Hylkää</button>
              </div>
            </form>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}


  {% if session.user_id and session.user_id != listing.user_id %}

    {% if rented %}
      <p><strong>Kohde on jo vuokrattu.</strong></p>

    {% elif user_offer %}
      {% if user_offer.owner_accepted %}
        <h3>Hakemuksesi on hyväksytty!</h3>

        <h3>Ilmoittajan yhteystiedot:</h3>
        <p>Puhelin: {{ listing.phone }}</p>
        <p>Sähköposti: {{ listing.email }}</p>

      {% else %}
        <p>Hakemus lähetetty! Odotetaan ilmoittajan vastausta.</p>
      {% endif %}

    {% else %}
      <h3>Vuokraa kohde</h3>

      {% if edit_offer %}
        <form class="form-stack" action="/create_offer" method="post">
          <div>
            Tarjous
            <input type="text" name="price" pattern="^[1-9][0-9]{0,4}$" required>
          </div>

          <input type="hidden" name="listing_id" value="{{ listing.id }}">
          <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
          <input type="submit" value="Lähetä hakemus">
        </form>

      {% else %}
        <form action="/listing/{{ listing.id }}" method="get">
          <input type="hidden" name="edit_offer" value="1">
          <button type="submit">Lähetä hakemus</button>
        </form>
      {% endif %}
    {% endif %}
  {% endif %}


  {% if session.user_id and session.user_id != listing.user_id and offers %}
    <h3>Oma hakemus:</h3>

    {% for offer in offers %}
      <p>
        Tarjous: {{ offer.price }} €
        {% if offer.owner_accepted %}
          (Hyväksytty)
        {% else %}
          (Odottaa)
        {% endif %}
      </p>

      {% if not offer.owner_accepted %}
        {% if edit_offer %}

          <form class="form-stack" action="/edit_offer/{{ offer.id }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">

            <div>
              Uusi tarjous
              <input type="text" name="price" value="{{ offer.price }}" pattern="^[1-9][0-9]{0,4}$" required>
            </div>

            <div class="grid grid-small">
              <button type="submit" name="action" value="update">Päivitä</button>
              <button type="submit" name="action" value="delete">Poista</button>
            </div>
          </form>

        {% else %}
          <form action="/listing/{{ listing.id }}" method="get">
            <input type="hidden" name="edit_offer" value="1">
            <button type="submit">Muokkaa hakemusta</button>
          </form>

          <form action="/edit_offer/{{ offer.id }}" method="post">
            <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
            <button type="submit" name="action" value="delete">Poista hakemus</button>
          </form>
        {% endif %}
      {% endif %}
    {% endfor %}
  {% endif %}

  {% if session.user_id %}
    <h3>Ilmoittaja</h3>

    <div class="grid grid-small">
      <p>
        <a href="/user/{{ listing.user_id }}">
          {{ listing.username }}
        </a>
      </p>
    </div>

  {% endif %}

  <h3>Asunnon tiedot</h3>

    <div class="grid grid-dual">
      <p><strong>Asuntotyyppi:</strong> {{ listing.property_type }}</p>
      <p><strong>Huonemäärä:</strong> {{ listing.rooms }} h</p>
      <p><strong>Neliömäärä:</strong> {{ listing.size | format_size }} m²</p>
      <p><strong>Vuokrahinta:</strong> {{ listing.rent }} €</p>
      <p><strong>Kunto:</strong> {{ listing.condition }}</p>
      <p><strong>Parveke:</strong> {{ "Kyllä" if listing.balcony else "Ei" }}</p>
      <p><strong>Sauna:</strong> {{ "Kyllä" if listing.sauna else "Ei" }}</p>
      {% if listing.floor %}
        <p><strong>Kerros:</strong> {{ listing.floor }} / {{ listing.floors }}</p>
      {% else %}
        <p><strong>Kerroksia:</strong> {{ listing.floors }}</p>
      {% endif %}
    </div>

    <p><strong>Kuvaus</strong></p>
    <p>{{ listing.description | show_lines }}</p>


  {% if listing.property_type == "Kerrostalo" %}
    <h3>Taloyhtiön tiedot</h3>

    <div class="grid grid-dual">
      <p><strong>Sauna:</strong> {{ "Kyllä" if listing.bath else "Ei" }}</p>
      <p><strong>Hissi:</strong> {{ "Kyllä" if listing.elevator else "Ei" }}</p>
      <p><strong>Pyykkitupa:</strong> {{ "Kyllä" if listing.laundry else "Ei" }}</p>
      <p><strong>Häkkikellari:</strong> {{ "Kyllä" if listing.cellar else "Ei" }}</p>
      <p><strong>Uima-allas:</strong> {{ "Kyllä" if listing.pool else "Ei" }}</p>
    </div>
  {% endif %}

</section>

{% endblock %}